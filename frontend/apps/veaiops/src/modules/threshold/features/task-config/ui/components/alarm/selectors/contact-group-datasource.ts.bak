// Copyright 2025 Beijing Volcano Engine Technology Co., Ltd. and/or its affiliates
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//      https://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

import apiClient from '@/utils/api-client';
import { API_RESPONSE_CODE } from '@veaiops/constants';
import { logger } from '@veaiops/utils';
import type { ZabbixUserGroup } from 'api-generate';

/**
 * 数据源设置器类型
 * 根据 @veaiops/components 中 Select.Block 的定义
 */
interface DataSourceSetter {
  serviceInstance: unknown;
  api: string;
  payload?: unknown;
  responseEntityKey: string;
  isJsonParse?: boolean;
  JsonParseEntityKey?: string;
  optionCfg: Partial<Record<string, unknown>>;
}

/**
 * 选择数据源属性类型
 */
interface SelectDataSourceProps {
  search?: unknown;
  remoteSearchParams?: unknown;
  pageReq?: { skip: number; limit: number };
  value?: unknown;
}

/**
 * 获取 Volcengine 联系组数据源配置
 *
 * @param datasourceId - 数据源ID
 * @returns DataSourceSetter 配置对象
 */
export const getVolcengineContactGroupDataSource = (
  datasourceId: string,
): DataSourceSetter => ({
  serviceInstance: apiClient.dataSources,
  api: 'getApisV1DatasourceVolcengineContactGroups',
  payload: { datasourceId },
  responseEntityKey: 'data',
  optionCfg: {
    labelKey: 'name',
    valueKey: 'id',
  },
});

/**
 * 获取 Aliyun 联系组列表（函数式数据源）
 *
 * Aliyun 的联系组接口需要：
 * 1. 先通过 datasourceId 获取 DataSource 详情
 * 2. 从 DataSource 中提取 connect_id
 * 3. 使用 connect_id 调用联系组接口
 *
 * @param datasourceId - 数据源ID
 * @returns 异步函数，返回 options 数组
 */
export const getAliyunContactGroupDataSource = (
  datasourceId: string,
): ((
  props?: SelectDataSourceProps,
) => Promise<Array<{ label: string; value: string; extra: unknown }>>) => {
  return async (props?: SelectDataSourceProps) => {
    const pagination = props?.pageReq || { skip: 0, limit: 100 };

    // ✅ 正确：使用 logger 记录调试信息
    logger.debug({
      message: '开始获取联系组',
      data: { datasourceId, pagination },
      source: 'AliyunContactGroupDataSource',
      component: 'getAliyunContactGroupDataSource',
    });

    try {
      // 步骤1: 获取 DataSource 详情
      const datasourceResponse =
        await apiClient.dataSources.getApisV1DatasourceAliyun1({
          datasourceId,
        });

      if (datasourceResponse.code !== API_RESPONSE_CODE.SUCCESS) {
        // ✅ 正确：使用 logger 记录错误
        logger.error({
          message: '获取数据源信息失败',
          data: {
            code: datasourceResponse.code,
            message: datasourceResponse.message,
            datasourceId,
          },
          source: 'AliyunContactGroupDataSource',
          component: 'getAliyunContactGroupDataSource',
        });
        return [];
      }

      if (!datasourceResponse.data) {
        // ✅ 正确：使用 logger 记录错误
        logger.error({
          message: '数据源信息为空',
          data: { datasourceId },
          source: 'AliyunContactGroupDataSource',
          component: 'getAliyunContactGroupDataSource',
        });
        return [];
      }

      // 步骤2: 提取 connect_id
      const dataSourceData = datasourceResponse.data;
      const connectId =
        dataSourceData?.connect?.id || dataSourceData?.connect?._id;

      if (!connectId) {
        // ✅ 正确：使用 logger 记录错误
        logger.error({
          message: '数据源未配置连接信息',
          data: { datasourceId },
          source: 'AliyunContactGroupDataSource',
          component: 'getAliyunContactGroupDataSource',
        });
        return [];
      }

      // ✅ 正确：使用 logger 记录调试信息
      logger.debug({
        message: '使用 connect_id 获取联系组',
        data: { connectId, pagination },
        source: 'AliyunContactGroupDataSource',
        component: 'getAliyunContactGroupDataSource',
      });

      // 步骤3: 调用联系组接口，支持分页
      const response =
        await apiClient.dataSourceConnect.postApisV1DatasourceConnectAliyunDescribeContactGroupList(
          {
            connectId,
            skip: pagination.skip,
            limit: pagination.limit,
          },
        );

      if (response.code === API_RESPONSE_CODE.SUCCESS && response.data) {
        const options = response.data.map((group) => ({
          label: group.Name || '',
          value: group.Name || '',
          extra: group,
        }));

        // ✅ 正确：使用 logger 记录成功信息
        logger.info({
          message: '联系组获取成功',
          data: { count: options.length, pagination },
          source: 'AliyunContactGroupDataSource',
          component: 'getAliyunContactGroupDataSource',
        });

        return options;
      }

      // ✅ 正确：使用 logger 记录错误
      logger.error({
        message: '接口返回错误',
        data: {
          code: response.code,
          message: response.message,
          datasourceId,
        },
        source: 'AliyunContactGroupDataSource',
        component: 'getAliyunContactGroupDataSource',
      });
      return [];
    } catch (error) {
      // ✅ 正确：使用 logger 记录错误，并透出实际错误信息
      const errorObj =
        error instanceof Error ? error : new Error(String(error));
      logger.error({
        message: '获取联系组失败',
        data: {
          error: errorObj.message,
          stack: errorObj.stack,
          datasourceId,
          errorObj,
        },
        source: 'AliyunContactGroupDataSource',
        component: 'getAliyunContactGroupDataSource',
      });
      return [];
    }
  };
};

/**
 * 获取 Volcengine 告警方式数据源配置
 *
 * @param datasourceId - 数据源ID
 * @returns DataSourceSetter 配置对象或undefined（使用静态选项）
 */
export const getVolcengineAlertMethodsDataSource = (_datasourceId: string) => {
  // Volcengine使用静态选项，不需要动态获取
  return undefined;
};

/**
 * 获取 Zabbix 告警方式（媒介类型）数据源配置
 *
 * @param datasourceId - 数据源ID
 * @returns 异步函数，返回 options 数组
 */
export const getZabbixAlertMethodsDataSource = (datasourceId: string) => {
  return async (props?: SelectDataSourceProps) => {
    // 确保datasourceId是字符串
    const datasourceIdStr =
      typeof datasourceId === 'string' ? datasourceId : String(datasourceId);

    const pagination = props?.pageReq || { skip: 0, limit: 1000 };

    // ✅ 正确：使用 logger 记录调试信息
    logger.debug({
      message: '开始获取媒介类型',
      data: { datasourceId: datasourceIdStr, pagination },
      source: 'ZabbixAlertMethodsDataSource',
      component: 'getZabbixAlertMethodsDataSource',
    });

    try {
      // 注意：Zabbix的mediatypes接口目前不支持分页，所以我们只在第一页时获取数据
      if (pagination.skip > 0) {
        return []; // 分页时返回空数组，表示没有更多数据
      }

      const response =
        await apiClient.intelligentThresholdAlarm.getApisV1DatasourceZabbixDatasourceMediatypes(
          {
            datasourceId: datasourceIdStr,
          },
        );
      // ✅ 正确：使用 logger 记录调试信息
      logger.debug({
        message: '媒介类型响应',
        data: { code: response.code, hasData: Boolean(response.data) },
        source: 'ZabbixAlertMethodsDataSource',
        component: 'getZabbixAlertMethodsDataSource',
      });
      if (response.code === API_RESPONSE_CODE.SUCCESS && response.data) {
        const options =
          response?.data?.map((mediatype) => ({
            label: mediatype.name || '',
            value: mediatype.media_type_id || '',
            extra: mediatype,
          })) || [];

        // ✅ 正确：使用 logger 记录成功信息
        logger.info({
          message: '媒介类型获取成功',
          data: { count: options.length, pagination },
          source: 'ZabbixAlertMethodsDataSource',
          component: 'getZabbixAlertMethodsDataSource',
        });

        return options;
      }

      // ✅ 正确：使用 logger 记录错误
      logger.error({
        message: '接口返回错误',
        data: {
          code: response.code,
          message: response.message,
          datasourceId: datasourceIdStr,
        },
        source: 'ZabbixAlertMethodsDataSource',
        component: 'getZabbixAlertMethodsDataSource',
      });
      return [];
    } catch (error) {
      // ✅ 正确：使用 logger 记录错误，并透出实际错误信息
      const errorObj =
        error instanceof Error ? error : new Error(String(error));
      logger.error({
        message: '获取媒介类型失败',
        data: {
          error: errorObj.message,
          stack: errorObj.stack,
          datasourceId: datasourceIdStr,
          errorObj,
        },
        source: 'ZabbixAlertMethodsDataSource',
        component: 'getZabbixAlertMethodsDataSource',
      });
      return [];
    }
  };
};

/**
 * 获取 Zabbix 媒介类型数据源配置（保持兼容性）
 *
 * @param datasourceId - 数据源ID
 * @returns 异步函数，返回 options 数组
 * @deprecated 使用 getZabbixAlertMethodsDataSource 代替
 */
export const getZabbixMediatypeDataSource = (datasourceId: string) => {
  return getZabbixAlertMethodsDataSource(datasourceId);
};

/**
 * 获取 Zabbix 联系组数据源配置
 *
 * @param datasourceId - 数据源ID
 * @returns 异步函数，返回 options 数组
 */
export const getZabbixContactGroupDataSource = (
  datasourceId: string,
): ((
  props?: SelectDataSourceProps,
) => Promise<
  Array<{ label: string; value: string; extra: ZabbixUserGroup }>
>) => {
  return async (props?: SelectDataSourceProps) => {
    const pagination = props?.pageReq || { skip: 0, limit: 100 };

    // ✅ 正确：使用 logger 记录调试信息
    logger.debug({
      message: '开始获取联系组',
      data: { datasourceId, pagination },
      source: 'ZabbixContactGroupDataSource',
      component: 'getZabbixContactGroupDataSource',
    });

    try {
      // 注意：Zabbix的usergroups接口目前不支持分页，所以我们只在第一页时获取数据
      if (pagination.skip > 0) {
        return []; // 分页时返回空数组，表示没有更多数据
      }

      const response =
        await apiClient.intelligentThresholdAlarm.getApisV1DatasourceZabbixDatasourceUsergroups(
          {
            datasourceId,
          },
        );

      if (response.code === API_RESPONSE_CODE.SUCCESS && response.data) {
        const options = response.data.map((group) => ({
          label: group.name || '',
          value: group.usrgrpid || '',
          extra: group,
        }));

        // ✅ 正确：使用 logger 记录成功信息
        logger.info({
          message: '联系组获取成功',
          data: { count: options.length, pagination },
          source: 'ZabbixContactGroupDataSource',
          component: 'getZabbixContactGroupDataSource',
        });

        return options;
      }

      // ✅ 正确：使用 logger 记录错误
      logger.error({
        message: '接口返回错误',
        data: {
          code: response.code,
          message: response.message,
          datasourceId,
        },
        source: 'ZabbixContactGroupDataSource',
        component: 'getZabbixContactGroupDataSource',
      });
      return [];
    } catch (error) {
      // ✅ 正确：使用 logger 记录错误，并透出实际错误信息
      const errorObj =
        error instanceof Error ? error : new Error(String(error));
      logger.error({
        message: '获取联系组失败',
        data: {
          error: errorObj.message,
          stack: errorObj.stack,
          datasourceId,
          errorObj,
        },
        source: 'ZabbixContactGroupDataSource',
        component: 'getZabbixContactGroupDataSource',
      });
      return [];
    }
  };
};
